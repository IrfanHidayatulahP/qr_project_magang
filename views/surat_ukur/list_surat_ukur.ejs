<%- include('../partials/header.ejs') %>

<div id="konten-surat-ukur" style="display: none;">
    <section class="container-fluid">
        
        <div class="header-action">
            <h1 class="page-title">Daftar Surat Ukur</h1>
            <div style="display:flex; gap:10px;">
                <a class="btn-add" href="/surat-ukur/create"><i class="fas fa-plus"></i> Tambah</a>
                <button id="btn-open-download" class="btn-add" type="button"><i class="fas fa-download"></i> Download</button>
            </div>
        </div>

        <% if (typeof error !=='undefined' && error) { %> <div class="alert alert-error"><%= error %></div> <% } %>
        <% if (typeof success !=='undefined' && success) { %> <div class="alert alert-success"><%= success %></div> <% } %>

        <form method="get" action="/surat-ukur" class="search-form">
            <input type="text" name="q" placeholder="Cari ID / No Surat Ukur / Lokasi..." value="<%= (typeof filter_q !== 'undefined') ? filter_q : '' %>" />
            <button type="submit"><i class="fas fa-search"></i> Cari</button>
        </form>

        <div class="table-wrapper">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nomor Surat Ukur</th>
                        <th>Nomor Hak</th>
                        <th>Jenis Hak</th>
                        <th>Tahun</th>
                        <th>Media</th>
                        <th>Jumlah</th>
                        <th>Lokasi</th>
                        <th>No Boks</th>
                        <th>No Folder</th>
                        <th>Metode</th>
                        <th>QR</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (Array.isArray(records) && records.length) { %>
                        <% records.forEach(r => { %>
                            <tr data-id="<%= r.id_surat_ukur %>">
                                <td><%= r.id_surat_ukur %></td>
                                <td><%= r.nomor_surat_ukur || '-' %></td>
                                <td><%= r.nomor_hak || '-' %></td>
                                <td><%= r.jenis_hak || '-' %></td>
                                <td>
                                    <% 
                                        let _year = '-'; 
                                        const tv = r.tahun_terbit; 
                                        if (tv) { 
                                            // Logic parsing tahun yang lebih ringkas
                                            if (tv instanceof Date) { _year = tv.getFullYear(); }
                                            else { 
                                                const s = String(tv).trim(); 
                                                if (/^\d{4}$/.test(s)) { _year = s; } 
                                                else { const d = new Date(s); _year = isNaN(d.getTime()) ? '-' : d.getFullYear(); } 
                                            } 
                                        } 
                                    %>
                                    <%= _year %>
                                </td>
                                <td><%= r.media || '-' %></td>
                                <td><%= (r.jumlah != null) ? r.jumlah : '-' %></td>
                                <td><%= r.lokasi_penyimpanan || '-' %></td>
                                <td><%= r.no_boks_definitif || '-' %></td>
                                <td><%= (r.nomor_folder != null) ? r.nomor_folder : '-' %></td>
                                <td><%= r.metode_perlindungan || '-' %></td>
                                
                                <td style="text-align:center;">
                                    <div class="qr-preview">
                                        <a href="/surat-ukur/<%= r.id_surat_ukur %>">
                                            <img src="/surat-ukur/<%= r.id_surat_ukur %>/qr.png" alt="QR" />
                                        </a>
                                    </div>
                                </td>
                                
                                <td class="action-links">
                                    <a href="/surat-ukur/<%= r.id_surat_ukur %>" class="link-detail" title="Lihat"><i class="fas fa-eye"></i></a>
                                    <a href="/surat-ukur/edit/<%= r.id_surat_ukur %>" class="link-edit" title="Edit"><i class="fas fa-edit"></i></a>
                                    <form action="/surat-ukur/delete/<%= r.id_surat_ukur %>" method="post" style="display:inline" onsubmit="return confirm('Hapus data surat ukur ini?');">
                                        <button type="submit" class="btn-delete" title="Hapus"><i class="fas fa-trash"></i></button>
                                    </form>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="13" style="text-align:center; padding:20px; color:#6b7280;">
                                Belum ada data surat ukur.
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>

        <div id="source-checkboxes" style="display:none;">
            <label><input type="checkbox" name="col" value="id_surat_ukur" checked> ID</label>
            <label><input type="checkbox" name="col" value="nomor_surat_ukur" checked> No. Surat Ukur</label>
            <label><input type="checkbox" name="col" value="nomor_hak" checked> Nomor Hak</label>
            <label><input type="checkbox" name="col" value="jenis_hak" checked> Jenis Hak</label>
            <label><input type="checkbox" name="col" value="tahun_terbit" checked> Tahun</label>
            <label><input type="checkbox" name="col" value="media" checked> Media</label>
            <label><input type="checkbox" name="col" value="jumlah" checked> Jumlah</label>
            <label><input type="checkbox" name="col" value="tingkat_perkembangan" checked> Perkembangan</label>
            <label><input type="checkbox" name="col" value="lokasi_penyimpanan" checked> Lokasi</label>
            <label><input type="checkbox" name="col" value="no_boks_definitif" checked> No Boks</label>
            <label><input type="checkbox" name="col" value="nomor_folder" checked> No Folder</label>
            <label><input type="checkbox" name="col" value="metode_perlindungan" checked> Metode Proteksi</label>
        </div>

    </section>
</div>

<%- include('../partials/list_template.ejs', { 
    baseUrl: '/surat-ukur', 
    contentId: 'konten-surat-ukur' 
}) %>