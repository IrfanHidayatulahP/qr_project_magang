<%- include('../partials/header.ejs') %>
<section class="container">
  <h1>Edit Surat Ukur - ID: <%= surat.id_surat_ukur %></h1>

  <% if (error) { %>
    <div class="alert alert-error"><%= error %></div>
  <% } %>
  <% if (success) { %>
    <div class="alert alert-success"><%= success %></div>
  <% } %>

  <form action="/surat-ukur/edit/<%= surat.id_surat_ukur %>" method="POST">
    <div class="form-row">
      <label>Nomor Hak (nomor_hak)</label>
      <input type="text" name="nomor_hak" maxlength="150" required value="<%= surat.nomor_hak || '' %>">
    </div>

    <div class="form-row">
      <label>Jenis Hak (jenis_hak)</label>
      <select name="jenis_hak">
        <option value="">-- pilih --</option>
        <option value="HM" <%= surat.jenis_hak === 'HM' ? 'selected' : '' %>>HM</option>
        <option value="HGB" <%= surat.jenis_hak === 'HGB' ? 'selected' : '' %>>HGB</option>
        <option value="HP" <%= surat.jenis_hak === 'HP' ? 'selected' : '' %>>HP</option>
        <option value="HGU" <%= surat.jenis_hak === 'HGU' ? 'selected' : '' %>>HGU</option>
        <option value="Pengelolaan" <%= surat.jenis_hak === 'Pengelolaan' ? 'selected' : '' %>>Pengelolaan</option>
        <option value="Lainnya" <%= surat.jenis_hak === 'Lainnya' ? 'selected' : '' %>>Lainnya</option>
      </select>
    </div>

    <div class="form-row">
      <label>Nomor Surat Ukur (nomor_surat_ukur)</label>
      <input type="text" name="nomor_surat_ukur" maxlength="255" value="<%= surat.nomor_surat_ukur || '' %>">
    </div>

    <% 
      // Cari nilai tahun yang aman untuk ditampilkan di input.
      // Hasilnya akan menjadi string 'YYYY' atau '' jika tidak available.
      let _tahunInput = '';
      if (surat && typeof surat.tahun_terbit !== 'undefined' && surat.tahun_terbit !== null && surat.tahun_terbit !== '') {
        try {
          const tv = surat.tahun_terbit;
          if (tv instanceof Date || Object.prototype.toString.call(tv) === '[object Date]') {
            _tahunInput = String((new Date(tv)).getFullYear());
          } else {
            const s = String(tv).trim();
            if (/^\d{4}$/.test(s)) {
              _tahunInput = s;
            } else {
              const d = new Date(s);
              _tahunInput = isNaN(d.getTime()) ? '' : String(d.getFullYear());
            }
          }
        } catch (e) {
          _tahunInput = '';
        }
      }
    %>

    <div class="form-row">
      <label>Tahun Terbit (tahun_terbit)</label>
      <!-- tampilkan HANYA tahun (YYYY) di field edit agar konsisten -->
      <input type="text" name="tahun_terbit" placeholder="contoh: 2020 atau 01-01-2020" value="<%= _tahunInput %>">
      <small style="color:#666">Tampil sebagai tahun (YYYY). Anda bisa masukkan tanggal lengkap jika perlu.</small>
    </div>

    <div class="form-row">
      <label>Media (media)</label>
      <select name="media">
        <option value="">-- pilih --</option>
        <option value="Kertas" <%= surat.media === 'Kertas' ? 'selected' : '' %>>Kertas</option>
        <option value="Digital" <%= surat.media === 'Digital' ? 'selected' : '' %>>Digital</option>
        <option value="Microfilm" <%= surat.media === 'Microfilm' ? 'selected' : '' %>>Microfilm</option>
      </select>
    </div>

    <div class="form-row">
      <label>Jumlah (jumlah)</label>
      <input type="number" name="jumlah" min="0" step="1" value="<%= (typeof surat.jumlah !== 'undefined' && surat.jumlah !== null) ? surat.jumlah : '' %>">
    </div>

    <div class="form-row">
      <label>Tingkat Perkembangan (tingkat_perkembangan)</label>
      <select name="tingkat_perkembangan">
        <option value="">-- pilih --</option>
        <option value="Asli" <%= surat.tingkat_perkembangan === 'Asli' ? 'selected' : '' %>>Asli</option>
        <option value="Copy" <%= surat.tingkat_perkembangan === 'Copy' ? 'selected' : '' %>>Copy</option>
        <option value="Salinan" <%= surat.tingkat_perkembangan === 'Salinan' ? 'selected' : '' %>>Salinan</option>
      </select>
    </div>

    <div class="form-row">
      <label>Lokasi Penyimpanan (lokasi_penyimpanan)</label>
      <select name="lokasi_penyimpanan">
        <option value="">-- pilih kode lokasi --</option>

        <% if (Array.isArray(locations) && locations.length) { %>
          <% locations.forEach(function(loc) {
               const label = (loc.kode_lokasi || '') + (loc.ruangan ? (' â€” ' + loc.ruangan) : '') + (loc.no_rak ? (' / Rak ' + loc.no_rak) : '');
               const selected = (typeof surat.lokasi_penyimpanan !== 'undefined' && surat.lokasi_penyimpanan === loc.kode_lokasi) ? 'selected' : '';
          %>
            <option value="<%= loc.kode_lokasi %>" <%= selected %>><%= label %></option>
          <% }); %>
        <% } else { %>
          <option disabled>Tidak ada data lokasi</option>
        <% } %>

      </select>
      <small style="color:#666">Pilih kode lokasi yang tersedia (diambil dari tabel lokasi).</small>
    </div>

    <div class="form-row">
      <label>No Boks Definitif (no_boks_definitif)</label>
      <input type="text" name="no_boks_definitif" maxlength="100" value="<%= surat.no_boks_definitif || '' %>">
    </div>

    <div class="form-row">
      <label>Nomor Folder (nomor_folder)</label>
      <input type="number" name="nomor_folder" min="0" step="1" value="<%= (typeof surat.nomor_folder !== 'undefined' && surat.nomor_folder !== null) ? surat.nomor_folder : '' %>">
    </div>

    <div class="form-row">
      <label>Metode Perlindungan (metode_perlindungan)</label>
      <select name="metode_perlindungan">
        <option value="">-- pilih --</option>
        <option value="Vaulting" <%= surat.metode_perlindungan === 'Vaulting' ? 'selected' : '' %>>Vaulting</option>
        <option value="Cloud" <%= surat.metode_perlindungan === 'Cloud' ? 'selected' : '' %>>Cloud</option>
        <option value="Physical" <%= surat.metode_perlindungan === 'Physical' ? 'selected' : '' %>>Physical</option>
      </select>
    </div>

    <div class="form-actions" style="margin-top:12px;">
      <button type="submit" class="btn btn-primary">Update</button>
      <a href="/surat-ukur" class="btn btn-secondary">Batal</a>
    </div>
  </form>
</section>
<%- include('../partials/footer.ejs') %>
