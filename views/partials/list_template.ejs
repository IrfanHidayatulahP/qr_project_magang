<style>
    /* 1. LAYOUT & UTILITIES */
    .container-fluid { width: 100%; }
    
    /* 2. COLOR PALETTE (TEMA ARISTA) */
    :root {
        --navy-blue: #003D5C;
        --bright-blue: #0099CC;
        --golden-yellow: #FFCC00;
        --cream-beige: #FFF8F0; /* Cream lebih terang agar tidak kusam */
        --light-blue: #E6F3FA;
        --white: #FFFFFF;
    }

    /* 3. HEADER & TITLE */
    .desktop-header {
        background: linear-gradient(135deg, var(--navy-blue) 0%, var(--bright-blue) 100%);
        padding: 20px;
        border-radius: 12px;
        color: white;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .desktop-header h3 {
        color: var(--golden-yellow) !important;
        font-weight: bold;
        margin: 0;
    }

    /* Mobile Header */
    .mobile-header {
        background: linear-gradient(135deg, var(--navy-blue) 0%, var(--bright-blue) 100%);
        border-radius: 8px;
        padding: 15px;
        color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .mobile-header h5 {
        color: var(--golden-yellow) !important;
    }

    /* 4. BUTTONS & ACTIONS */
    .btn-primary {
        background-color: var(--bright-blue);
        border-color: var(--bright-blue);
        color: white;
    }
    .btn-primary:hover, .btn-primary:focus {
        background-color: var(--navy-blue);
        border-color: var(--navy-blue);
    }

    .btn-success {
        background-color: var(--golden-yellow);
        border-color: var(--golden-yellow);
        color: var(--navy-blue);
        font-weight: 600;
    }
    .btn-success:hover {
        background-color: #E6B800;
        border-color: #E6B800;
        color: var(--navy-blue);
    }

    /* Outline Buttons */
    .btn-outline-danger { color: var(--navy-blue); border-color: var(--navy-blue); }
    .btn-outline-danger:hover { background-color: var(--navy-blue); color: white; }

    .btn-outline-primary { color: var(--bright-blue); border-color: var(--bright-blue); }
    .btn-outline-primary:hover { background-color: var(--bright-blue); color: white; }

    /* Action Buttons (Edit/View/Delete) */
    .btn-info { background-color: var(--bright-blue) !important; color: white !important; border: none; }
    .btn-info:hover { background-color: var(--navy-blue) !important; }

    .btn-warning { background-color: var(--golden-yellow) !important; color: var(--navy-blue) !important; border: none; }
    .btn-warning:hover { background-color: #E6B800 !important; }

    .btn-danger { background-color: #E74C3C !important; border: none; }

    /* 5. SEARCH FORM */
    .search-box input { border-color: var(--bright-blue); }
    .search-box input:focus { 
        border-color: var(--navy-blue); 
        box-shadow: 0 0 0 0.2rem rgba(0, 153, 204, 0.25); 
    }
    .input-group-text {
        border-color: var(--bright-blue);
        color: var(--navy-blue);
        background-color: var(--light-blue);
    }

    /* 6. TABLE STYLING */
    .table-wrapper {
        overflow-x: auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .table { width: 100%; border-collapse: collapse; }
    
    .table-light { background-color: var(--light-blue) !important; }
    
    .table th {
        color: var(--navy-blue);
        font-weight: 700;
        border-bottom: 3px solid var(--bright-blue);
        padding: 12px 15px;
        background-color: var(--light-blue);
        white-space: nowrap;
    }

    .table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e5e7eb;
        vertical-align: middle;
        color: var(--navy-blue);
    }

    .table tbody tr:hover { background-color: rgba(0, 153, 204, 0.05); }

    /* 7. CARDS (Mobile & Container) */
    .card {
        background-color: var(--cream-beige) !important;
        border: 1px solid var(--bright-blue) !important;
        border-radius: 12px;
    }
    
    .card.shadow-sm { box-shadow: 0 2px 8px rgba(0,0,0,0.05) !important; }

    /* 8. ALERTS & BADGES */
    .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 500; }
    
    .alert-danger {
        background-color: rgba(231, 76, 60, 0.1);
        border: 1px solid #E74C3C;
        color: var(--navy-blue);
    }
    
    .alert-success {
        background-color: rgba(0, 153, 204, 0.1);
        border: 1px solid var(--bright-blue);
        color: var(--navy-blue);
    }

    .badge { font-weight: 600; padding: 6px 10px; }
    .badge.bg-info {
        background-color: var(--light-blue) !important;
        color: var(--navy-blue) !important;
        border: 1px solid var(--bright-blue);
    }
    .badge.bg-primary { background-color: var(--bright-blue) !important; }

    /* 9. TEXT UTILITIES */
    h6.fw-bold { color: var(--navy-blue); }
    .text-muted { color: var(--navy-blue) !important; opacity: 0.7; }
    .text-secondary { color: var(--navy-blue) !important; }

    /* 10. COMPONENTS (QR, Modal, etc) */
    .img-thumbnail { border-color: var(--bright-blue); padding: 4px; }

    /* Modal Overlay */
    .modal-overlay {
        display: none;
        position: fixed; inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center; justify-content: center;
        backdrop-filter: blur(2px);
    }

    .modal-box {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        max-width: 90%;
        border-top: 5px solid var(--bright-blue);
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>


<!-- QR modal (small preview) -->
<div id="qr-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-box" style="width: 400px; text-align: center;">
        <h3 style="margin-top: 0; color: #1e3a8a;">QR Code</h3>
        <div style="margin: 15px 0;">
            <img id="qr-modal-img" src="" alt="QR Preview"
                style="width: 200px; height: 200px; object-fit: contain; border: 1px solid #eee;" />
        </div>
        <div style="display:flex;justify-content:center;gap:10px;">
            <a id="qr-modal-download" href="#" class="btn-add" target="_blank"><i class="fas fa-download"></i> Unduh</a>
            <button id="qr-modal-close" class="btn-add btn-secondary" type="button">Tutup</button>
        </div>
    </div>
</div>

<!-- Download modal (Bootstrap markup kept for compatibility; JS will use this element) -->
<div class="modal fade" id="modalDownload" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form id="form-download" method="GET" action="<%= baseUrl %>/download" class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="fas fa-download me-2"></i>Download Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <!-- FORMAT -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Format File</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="format" value="csv" checked>
                            <label class="form-check-label">CSV</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="format" value="docx">
                            <label class="form-check-label">DOCX (dengan QR)</label>
                        </div>
                    </div>
                </div>

                <!-- KOLOM: default list, dapat digantikan dengan #source-checkboxes jika ada -->
                <div class="mb-2">
                    <label class="form-label fw-semibold">Kolom yang diikutkan</label>
                    <div id="download-modal-columns" class="row row-cols-2 small">
                        <label><input type="checkbox" name="col" value="id_buku_tanah" checked> ID</label>
                        <label><input type="checkbox" name="col" value="nomor_hak" checked> Nomor Hak</label>
                        <label><input type="checkbox" name="col" value="jenis_hak" checked> Jenis Hak</label>
                        <label><input type="checkbox" name="col" value="tahun_terbit" checked> Tahun</label>
                        <label><input type="checkbox" name="col" value="media" checked> Media</label>
                        <label><input type="checkbox" name="col" value="jumlah" checked> Jumlah</label>
                        <label><input type="checkbox" name="col" value="lokasi_penyimpanan" checked> Lokasi</label>
                    </div>
                </div>
            </div>

            <!-- FILTER TAHUN (opsional) -->
            <div class="mb-3">
                <label class="form-label fw-semibold">Filter Tahun (opsional)</label>

                <% if (typeof years !=='undefined' && Array.isArray(years) && years.length) { %>
                    <select name="year" id="download-year" class="form-select">
                        <option value="">Semua Tahun</option>
                        <% years.forEach(function(y){ %>
                            <option value="<%= y %>" <%=(typeof filter_year !=='undefined' &&
                                String(filter_year)===String(y)) ? 'selected' : '' %>><%= y %>
                            </option>
                            <% }) %>
                    </select>
                    <div class="form-text small">Pilih tahun untuk memfilter data berdasarkan tahun terbit.</div>
                    <% } else { %>
                        <input type="number" name="year" id="download-year" class="form-control" placeholder="YYYY"
                            min="1900" max="3000" />
                        <div class="form-text small">Masukkan tahun (mis. 2023) untuk memfilter berdasarkan tahun
                            terbit.</div>
                        <% } %>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="submit" class="btn btn-success"><i class="fas fa-download me-1"></i> Download</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // EJS variables passed when including partial
        const BASE_URL = "<%= baseUrl %>";
        const CONTENT_ID = "<%= contentId %>";

        // ---- Move content block from page into .main-content if present ----
        const konten = document.getElementById(CONTENT_ID);
        const mainLayout = document.querySelector('.main-content');
        if (konten && mainLayout) {
            // wrap then append (keamanan: clone)
            const wrapper = document.createElement('div');
            wrapper.innerHTML = konten.innerHTML;
            mainLayout.appendChild(wrapper);
            konten.remove();
        }

        // ---- If page provided '#source-checkboxes', use it to populate modal columns ----
        const sourceCheckboxes = document.getElementById('source-checkboxes');
        const modalColumns = document.getElementById('download-modal-columns');
        if (sourceCheckboxes && modalColumns) {
            modalColumns.innerHTML = sourceCheckboxes.innerHTML;
            // remove source to avoid duplicates
            sourceCheckboxes.remove();
        }

        // ---- QR modal logic (preview + download link) ----
        const qrModalOverlay = document.getElementById('qr-modal');
        const qrImg = document.getElementById('qr-modal-img');
        const qrDownload = document.getElementById('qr-modal-download');
        const qrClose = document.getElementById('qr-modal-close');

        // delegate click on any QR thumbnail: they should have attribute data-qr-url or link to /:id/qr.png
        document.body.addEventListener('click', function (e) {
            const tgt = e.target.closest('[data-qr-id]') || e.target.closest('a[data-qr-url]');
            if (!tgt) return;
            e.preventDefault();
            // build URL
            let url = tgt.getAttribute('data-qr-url');
            if (!url) {
                const id = tgt.getAttribute('data-qr-id');
                if (id) url = `${BASE_URL}/${encodeURIComponent(id)}/qr.png`;
            }
            if (!url) return;
            qrImg.src = url;
            qrDownload.href = url.replace(/\/qr\.png$/, '/qr/download') || url;
            qrModalOverlay.style.display = 'flex';
            qrModalOverlay.setAttribute('aria-hidden', 'false');
        });

        if (qrClose) qrClose.addEventListener('click', function () {
            qrModalOverlay.style.display = 'none';
            qrModalOverlay.setAttribute('aria-hidden', 'true');
            qrImg.src = '';
        });

        // close modal on outside click
        window.addEventListener('click', function (ev) {
            if (ev.target === qrModalOverlay) {
                qrModalOverlay.style.display = 'none';
                qrModalOverlay.setAttribute('aria-hidden', 'true');
                qrImg.src = '';
            }
        });

        // ---- Download form: intercept submit, build query and redirect ----
        const formDownload = document.getElementById('form-download');
        if (formDownload) {
            formDownload.addEventListener('submit', function (ev) {
                ev.preventDefault();

                // gather selected columns (modal checkboxes)
                const checked = Array.from(formDownload.querySelectorAll('input[name="col"]:checked')).map(i => i.value.trim()).filter(Boolean);
                if (checked.length === 0) {
                    alert('Harap pilih minimal satu kolom untuk diekspor.');
                    return;
                }

                // format (csv | docx)
                const format = (formDownload.querySelector('input[name="format"]:checked') || {}).value || 'csv';

                // current search q (try to find search input in page)
                let q = '';
                const searchInput = document.querySelector('form.search-form input[name="q"]') || document.querySelector('input[name="q"]');
                if (searchInput) q = searchInput.value.trim();

                // build query string
                const params = new URLSearchParams();
                params.set('format', format);
                params.set('columns', checked.join(','));
                if (q) params.set('q', q);

                // ambil year input/select (dukungan untuk <select> dan <input>)
                const yearInput = formDownload.querySelector('select[name="year"], input[name="year"]');
                if (yearInput) {
                    const y = (yearInput.value || '').toString().trim();
                    if (y) params.set('year', y);
                }

                // redirect to download endpoint
                window.location.href = `${BASE_URL}/download?` + params.toString();

            });
        }

        // ---- Utility: when user clicks button "Download" on page, open modal  ----
        const btnOpenDownload = document.getElementById('btn-open-download');
        if (btnOpenDownload) {
            btnOpenDownload.addEventListener('click', function (ev) {
                ev.preventDefault();
                // If bootstrap modal exists and bootstrap JS is present, try to use it; otherwise toggle simple display
                const modalEl = document.getElementById('modalDownload');
                if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    // using bootstrap's modal
                    const bsModal = new bootstrap.Modal(modalEl);
                    bsModal.show();
                } else {
                    // fallback: make modal visible
                    // create overlay manually from the modal's markup
                    modalEl.classList.add('show');
                    modalEl.style.display = 'block';
                    // add simple backdrop
                    let backdrop = document.querySelector('.list-template-backdrop');
                    if (!backdrop) {
                        backdrop = document.createElement('div');
                        backdrop.className = 'list-template-backdrop';
                        backdrop.style.position = 'fixed';
                        backdrop.style.inset = 0;
                        backdrop.style.background = 'rgba(0,0,0,0.5)';
                        backdrop.style.zIndex = 1040;
                        document.body.appendChild(backdrop);
                        backdrop.addEventListener('click', () => {
                            modalEl.classList.remove('show');
                            modalEl.style.display = 'none';
                            backdrop.remove();
                        });
                    }
                }
            });
        }

        // graceful cleanup when modal close (if bootstrap not available we hide modal on pressing Esc)
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const modalEl = document.getElementById('modalDownload');
                if (modalEl && modalEl.classList.contains('show')) {
                    modalEl.classList.remove('show');
                    modalEl.style.display = 'none';
                    const backdrop = document.querySelector('.list-template-backdrop');
                    if (backdrop) backdrop.remove();
                }
            }
        });
    });
</script>