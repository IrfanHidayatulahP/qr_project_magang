<style>
    /* Layout & Utilities */
    .container-fluid {
        width: 100%;
    }

    .header-action {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .page-title {
        font-size: 24px;
        color: #1e3a8a;
        font-weight: bold;
        margin: 0;
    }

    /* Tombol */
    .btn-add {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        background-color: #1e40af;
        color: white;
        text-decoration: none;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-add:hover {
        background-color: #1e3a8a;
    }

    .btn-secondary {
        background-color: #6b7280;
    }

    .btn-secondary:hover {
        background-color: #4b5563;
    }

    /* Search Form */
    .search-form {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .search-form input[type="text"] {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        width: 300px;
    }

    .search-form button {
        padding: 8px 16px;
        background-color: #1e40af;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    /* Tabel */
    .table-wrapper {
        overflow-x: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0;
    }

    .table th,
    .table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
        vertical-align: middle;
    }

    .table th {
        background-color: #f8fafc;
        font-weight: 600;
        color: #1e3a8a;
        white-space: nowrap;
    }

    .table tr:hover {
        background-color: #f1f5f9;
    }

    /* Aksi & Alerts */
    .action-links a {
        text-decoration: none;
        margin-right: 8px;
        font-size: 16px;
    }

    .link-detail {
        color: #1e40af;
    }

    .link-edit {
        color: #d97706;
    }

    .btn-delete {
        color: #dc2626;
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        font-size: 16px;
    }

    .alert {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 14px;
    }

    .alert-error {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .alert-success {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }

    /* QR Preview Kecil */
    .qr-preview img {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border: 1px solid #eee;
        padding: 2px;
        background: #fff;
    }

    /* Modal Styling */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .modal-box {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        max-width: 95%;
        animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    /* small tweaks for bootstrap modal fallback */
    .modal .modal-body {
        max-height: 60vh;
        overflow-y: auto;
    }
</style>

<!-- QR modal (small preview) -->
<div id="qr-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-box" style="width: 400px; text-align: center;">
        <h3 style="margin-top: 0; color: #1e3a8a;">QR Code</h3>
        <div style="margin: 15px 0;">
            <img id="qr-modal-img" src="" alt="QR Preview"
                style="width: 200px; height: 200px; object-fit: contain; border: 1px solid #eee;" />
        </div>
        <div style="display:flex;justify-content:center;gap:10px;">
            <a id="qr-modal-download" href="#" class="btn-add" target="_blank"><i class="fas fa-download"></i> Unduh</a>
            <button id="qr-modal-close" class="btn-add btn-secondary" type="button">Tutup</button>
        </div>
    </div>
</div>

<!-- Download modal (Bootstrap markup kept for compatibility; JS will use this element) -->
<div class="modal fade" id="modalDownload" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form id="form-download" method="GET" action="<%= baseUrl %>/download" class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="fas fa-download me-2"></i>Download Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <!-- FORMAT -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Format File</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="format" value="csv" checked>
                            <label class="form-check-label">CSV</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="format" value="docx">
                            <label class="form-check-label">DOCX (dengan QR)</label>
                        </div>
                    </div>
                </div>

                <!-- KOLOM: default list, dapat digantikan dengan #source-checkboxes jika ada -->
                <div class="mb-2">
                    <label class="form-label fw-semibold">Kolom yang diikutkan</label>
                    <div id="download-modal-columns" class="row row-cols-2 small">
                        <label><input type="checkbox" name="col" value="id_buku_tanah" checked> ID</label>
                        <label><input type="checkbox" name="col" value="nomor_hak" checked> Nomor Hak</label>
                        <label><input type="checkbox" name="col" value="jenis_hak" checked> Jenis Hak</label>
                        <label><input type="checkbox" name="col" value="tahun_terbit" checked> Tahun</label>
                        <label><input type="checkbox" name="col" value="media" checked> Media</label>
                        <label><input type="checkbox" name="col" value="jumlah" checked> Jumlah</label>
                        <label><input type="checkbox" name="col" value="lokasi_penyimpanan" checked> Lokasi</label>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="submit" class="btn btn-success"><i class="fas fa-download me-1"></i> Download</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // EJS variables passed when including partial
        const BASE_URL = "<%= baseUrl %>";
        const CONTENT_ID = "<%= contentId %>";

        // ---- Move content block from page into .main-content if present ----
        const konten = document.getElementById(CONTENT_ID);
        const mainLayout = document.querySelector('.main-content');
        if (konten && mainLayout) {
            // wrap then append (keamanan: clone)
            const wrapper = document.createElement('div');
            wrapper.innerHTML = konten.innerHTML;
            mainLayout.appendChild(wrapper);
            konten.remove();
        }

        // ---- If page provided '#source-checkboxes', use it to populate modal columns ----
        const sourceCheckboxes = document.getElementById('source-checkboxes');
        const modalColumns = document.getElementById('download-modal-columns');
        if (sourceCheckboxes && modalColumns) {
            modalColumns.innerHTML = sourceCheckboxes.innerHTML;
            // remove source to avoid duplicates
            sourceCheckboxes.remove();
        }

        // ---- QR modal logic (preview + download link) ----
        const qrModalOverlay = document.getElementById('qr-modal');
        const qrImg = document.getElementById('qr-modal-img');
        const qrDownload = document.getElementById('qr-modal-download');
        const qrClose = document.getElementById('qr-modal-close');

        // delegate click on any QR thumbnail: they should have attribute data-qr-url or link to /:id/qr.png
        document.body.addEventListener('click', function (e) {
            const tgt = e.target.closest('[data-qr-id]') || e.target.closest('a[data-qr-url]');
            if (!tgt) return;
            e.preventDefault();
            // build URL
            let url = tgt.getAttribute('data-qr-url');
            if (!url) {
                const id = tgt.getAttribute('data-qr-id');
                if (id) url = `${BASE_URL}/${encodeURIComponent(id)}/qr.png`;
            }
            if (!url) return;
            qrImg.src = url;
            qrDownload.href = url.replace(/\/qr\.png$/, '/qr/download') || url;
            qrModalOverlay.style.display = 'flex';
            qrModalOverlay.setAttribute('aria-hidden', 'false');
        });

        if (qrClose) qrClose.addEventListener('click', function () {
            qrModalOverlay.style.display = 'none';
            qrModalOverlay.setAttribute('aria-hidden', 'true');
            qrImg.src = '';
        });

        // close modal on outside click
        window.addEventListener('click', function (ev) {
            if (ev.target === qrModalOverlay) {
                qrModalOverlay.style.display = 'none';
                qrModalOverlay.setAttribute('aria-hidden', 'true');
                qrImg.src = '';
            }
        });

        // ---- Download form: intercept submit, build query and redirect ----
        const formDownload = document.getElementById('form-download');
        if (formDownload) {
            formDownload.addEventListener('submit', function (ev) {
                ev.preventDefault();

                // gather selected columns (modal checkboxes)
                const checked = Array.from(formDownload.querySelectorAll('input[name="col"]:checked')).map(i => i.value.trim()).filter(Boolean);
                if (checked.length === 0) {
                    alert('Harap pilih minimal satu kolom untuk diekspor.');
                    return;
                }

                // format (csv | docx)
                const format = (formDownload.querySelector('input[name="format"]:checked') || {}).value || 'csv';

                // current search q (try to find search input in page)
                let q = '';
                const searchInput = document.querySelector('form.search-form input[name="q"]') || document.querySelector('input[name="q"]');
                if (searchInput) q = searchInput.value.trim();

                // build query string
                const params = new URLSearchParams();
                params.set('format', format);
                params.set('columns', checked.join(','));
                if (q) params.set('q', q);

                // redirect to download endpoint
                window.location.href = `${BASE_URL}/download?` + params.toString();
            });
        }

        // ---- Utility: when user clicks button "Download" on page, open modal  ----
        const btnOpenDownload = document.getElementById('btn-open-download');
        if (btnOpenDownload) {
            btnOpenDownload.addEventListener('click', function (ev) {
                ev.preventDefault();
                // If bootstrap modal exists and bootstrap JS is present, try to use it; otherwise toggle simple display
                const modalEl = document.getElementById('modalDownload');
                if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    // using bootstrap's modal
                    const bsModal = new bootstrap.Modal(modalEl);
                    bsModal.show();
                } else {
                    // fallback: make modal visible
                    // create overlay manually from the modal's markup
                    modalEl.classList.add('show');
                    modalEl.style.display = 'block';
                    // add simple backdrop
                    let backdrop = document.querySelector('.list-template-backdrop');
                    if (!backdrop) {
                        backdrop = document.createElement('div');
                        backdrop.className = 'list-template-backdrop';
                        backdrop.style.position = 'fixed';
                        backdrop.style.inset = 0;
                        backdrop.style.background = 'rgba(0,0,0,0.5)';
                        backdrop.style.zIndex = 1040;
                        document.body.appendChild(backdrop);
                        backdrop.addEventListener('click', () => {
                            modalEl.classList.remove('show');
                            modalEl.style.display = 'none';
                            backdrop.remove();
                        });
                    }
                }
            });
        }

        // graceful cleanup when modal close (if bootstrap not available we hide modal on pressing Esc)
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const modalEl = document.getElementById('modalDownload');
                if (modalEl && modalEl.classList.contains('show')) {
                    modalEl.classList.remove('show');
                    modalEl.style.display = 'none';
                    const backdrop = document.querySelector('.list-template-backdrop');
                    if (backdrop) backdrop.remove();
                }
            }
        });
    });
</script>